autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 2

ingress:
  enabled: true
  type: nginx
  tls:
    dev-status-dashboard:
      secretName: status-test.dnatls.uw.edu-ingress-cert
      hosts:
        - status-test.dnatls.uw.edu
  hosts:
    dev-status-dashboard:
      host: status-test.dnatls.uw.edu
      paths:
        - "/"
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/limit-rps: "10"

repo: status-dashboard
instance: test

containerPort: 8000

resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 25m
    memory: 64Mi

service:
  enabled: true
  ports:
    - port: 80
      targetPort: 8000
      name: http

deploymentInitialization:
  enabled: false

database:
  engine: null

metrics:
  enabled: true

readiness:
  enabled: true
  command:
    - "/scripts/ready.sh"


lifecycle:
  enabled: false

environmentVariables:
  - name: ENV
    value: dev
  - name: DASHBOARD_CONFIG_FILE
    value: /app/config/dashboard.yml

podVolumes:
  status-dashboard-config:
    volume:
      configMap:
        name: status-dashboard-config
    mount:
      mountPath: /app/config/dashboard.yml
      subPath: dashboard.yml
    containers: [ base ]

configmaps:
  status-dashboard-config:
    dashboard.yml: |
      variables:
        prometheus_api_server: http://prometheus-k8s.mci-monitoring.svc.cluster.local:9090
        sample_period: 10m
        timezone: US/Pacific
      dashboards:
        # application's display name
        - app_name: MyUW
          # status page url path: /{app_path}
          app_path: myuw
          # bucket supplying dynamic status notifications
          app_notification_url: https://storage.googleapis.com/status-dashboard/myuw/update.html?update=now
          # status page cache timeout in minutes (optional: default is 5)
          cache_timeout: 1
          panels:
            - name: MyUW Status
              services:
                # list of application components and the prometheus query to determine health
                - name: MyUW
                  description: UW student and faculty information portal
                  link: https://test.my.uw.edu
                  #
                  # query should return a scalar value to test the threshold values against
                  #
                  query: (sum(increase(nginx_ingress_controller_requests{exported_service="myuw-prod-test",controller_class=~"k8s.io/ingress-nginx",namespace=~"ingress-nginx",status=~"([123]..|40[134]|499|543)"}[$sample_period]) OR vector(1))) / (sum(increase(nginx_ingress_controller_requests{exported_service="myuw-prod-test",controller_class=~"k8s.io/ingress-nginx",namespace=~"ingress-nginx"}[$sample_period]) OR vector(1)))
                  #
                  # query results less than the threshold value indicates the service is struggling and displays the corresponding description
                  #
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.99
                      description: Degraded
            - name: Critical Services
              description: Services required to provide MyUW access and content.
              critical_description: As not all critical services appear healthy, MyUW is likely unavailable and serving an error page.
              services:
                # A list of dependent services and the query to determine its healthiness
                - name: Key Web Service
                  description: Required for secure service access
                  level: Blocker
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="kws", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="kws", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Group Web Service
                  description: Required for user affiliation information
                  level: Blocker
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="gws", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="gws", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Person Web Service
                  description: Required for specific user information
                  level: Blocker
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="pws", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="pws", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Student Web Service
                  description: Source of course, personal enrollment, notice, and registration information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="sws", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="sws", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: IdP OIDC Keyset
                  description: Required for mobile application authentication
                  level: Blocker
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="uwidp", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="uwidp", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: UWNetID Web Service
                  description: Source of uwnetid password and subscription information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="uwnetid", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="uwnetid", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
            - name: Dependent Service Status
              description: Services providing specific MyUW content.
              critical_description: As not all services appear healthy, some MyUW content may be missing or displaying an error message.
              services:
                - name: SDB Applicant Service
                  description: Source of undergrad application information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="sdbmyuw", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="sdbmyuw", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: MyPlan Auth Service
                  description: Source of MyPlan authentication
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="myplan_auth", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="myplan_auth", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: MyPlan Service
                  description: Source of MyPlan course information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="myplan", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="myplan", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: UW Canvas
                  description: Source of Canvas course information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="canvas", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="canvas", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Instructor Course Dashboard
                  description: Source of instructor course dashboard information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="coda", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="coda", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Instructor Gradepage API
                  description: Source of grade gubmission information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="gradepage", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="gradepage", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: MailMan API
                  description: Source of instructor class mailing list request data
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="mailman", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="mailman", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Housing and Food Services API
                  description: Provides Husky card information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="hfs", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="hfs", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Library Account API
                  description: Source of user library account information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="libraries", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="libraries", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Library Curriculum API
                  description: Source of library Curriculum information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="libcurric", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="libcurric", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Book store API
                  description: Source of course textbook information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="book", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="book", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Iasystem API
                  description: Source of course evaluation information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="iasystem", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="iasystem", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: UPASS API
                  description: Source of UPASS information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="upass", job="myuw-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="upass", job="myuw-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
        - app_name: Provision Request Tool
          # status page url path: /{app_path}
          app_path: provision
          # status page cache timeout (optional: default is 5 minutes)
          cache_timeout: 1
          panels:
            - name: Provision Request Tool (PRT) Status
              services:
                # list of application components and the prometheus query to determine health
                - name: Provision Request Tool
                  description: Service provisioning and lifecycle manager
                  link: https://test.provision.uw.edu
                  query: (sum(increase(nginx_ingress_controller_requests{exported_service="prt-prod-test",controller_class=~"k8s.io/ingress-nginx",namespace=~"ingress-nginx",status=~"([123]..|40[134]|499|543)"}[$sample_period]) OR vector(1))) / (sum(increase(nginx_ingress_controller_requests{exported_service="prt-prod-test",controller_class=~"k8s.io/ingress-nginx",namespace=~"ingress-nginx"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.99
                      description: Degraded
            - name: Dependent Service Status
              description: Services used for provisioning
              services:
                # list of each dependent service and the test to determine its healthiness
                - name: UW Person Web Service
                  description: Source of personal information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="pws", job="prt-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="pws", job="prt-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: Groups Web Service
                  description: Provides UW institutional group information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="gws", job="prt-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="gws", job="prt-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: UW NetID Web Service
                  description: Source of personal information
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="uwnetid", job="prt-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="uwnetid", job="prt-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: MSCA Web Service
                  description: UW Microsoft Collaborative Applications API
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="msca", job="prt-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="msca", job="prt-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
                - name: ITBill Web Service
                  description: UW Billing Subscription Service API
                  query: (sum(increase(restclient_response_status_code_bucket{exported_service="itbill", job="prt-prod-test", le=~"400(.0)?"}[$sample_period]) OR vector(1))) / (sum(increase(restclient_response_status_code_bucket{exported_service="itbill", job="prt-prod-test", le=~"500(.0)?"}[$sample_period]) OR vector(1)))
                  threshold:
                    - limit: 0.75
                      description: Critical
                    - limit: 0.98
                      description: Degraded
